<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Youth Robotics Interest Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #topbar {
      padding: 12px 14px;
      border-bottom: 1px solid #e6e6e6;
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    }
    #map { width: 100vw; height: calc(100vh - 62px); }
    .small { color: #555; font-size: 12px; }
    .pill { padding: 4px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    .warn { color: #7a3; }
    .err { color: #b00; }
    #stats-box {
      position: absolute;
      bottom: 30px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 13px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1;
      min-width: 180px;
    }
    #stats-box h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 6px;
    }
    #stats-box .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    #stats-box .stat-label { color: #666; }
    #stats-box .stat-value { font-weight: bold; }

    /* Widgets Panel */
    #widgets-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 340px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      background: rgba(255,255,255,0.97);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      z-index: 1;
      font-size: 13px;
    }
    .widget {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .widget:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .widget-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
    }
    .widget-value {
      font-size: 32px;
      font-weight: 700;
      margin: 8px 0;
    }
    .widget-subtitle {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .value-red { color: #dc2626; }
    .value-yellow { color: #ca8a04; }
    .value-green { color: #16a34a; }

    /* Progress bar */
    .progress-container {
      width: 100%;
      height: 24px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
      margin: 8px 0;
    }
    .progress-bar {
      height: 100%;
      transition: width 0.3s ease;
    }
    .progress-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      font-weight: 600;
      color: #1f2937;
      z-index: 1;
    }

    /* Bar chart */
    .bar-chart {
      margin-top: 8px;
    }
    .bar-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }
    .bar-label {
      width: 100px;
      font-size: 11px;
      font-weight: 500;
      color: #374151;
    }
    .bar-visual {
      flex: 1;
      height: 20px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    .bar-count {
      width: 30px;
      text-align: right;
      font-size: 11px;
      font-weight: 600;
    }

    /* Donut chart */
    .donut-container {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
    }
    .donut-chart {
      width: 80px;
      height: 80px;
      position: relative;
    }
    .donut-legend {
      flex: 1;
    }
    .legend-item {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 11px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      display: inline-block;
      margin-right: 6px;
    }

    /* Traffic lights */
    .traffic-lights {
      margin-top: 8px;
    }
    .traffic-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      padding: 8px;
      border-radius: 6px;
      background: #f9fafb;
    }
    .traffic-light {
      font-size: 20px;
    }
    .traffic-details {
      flex: 1;
    }
    .traffic-program {
      font-size: 12px;
      font-weight: 600;
      color: #1f2937;
    }
    .traffic-stats {
      font-size: 10px;
      color: #6b7280;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div>
      <div><b>Weighting</b></div>
      <label class="pill"><input type="radio" name="weightMode" value="kids" checked /> # kids</label>
      <label class="pill"><input type="radio" name="weightMode" value="households" /> households</label>
      <label class="pill"><input type="radio" name="weightMode" value="kids_6_8" /> kids age 6‚Äì8</label>
      <label class="pill"><input type="radio" name="weightMode" value="kids_9_12" /> kids age 9‚Äì12</label>
      <label class="pill"><input type="radio" name="weightMode" value="kids_13_17" /> kids age 13‚Äì17</label>
    </div>

    <div id="status" class="small"></div>

    <div>
      <div><b>Clusters</b></div>
      <input type="number" id="cluster-count" min="1" max="20" value="2" style="width:50px;padding:4px">
      <button id="run-clusters" style="padding:4px 8px">Show Clusters</button>
      <button id="clear-clusters" style="padding:4px 8px">Clear</button>
    </div>
  </div>

  <div id="map">
    <div id="widgets-panel" style="display:none">
      <!-- Widget 1: Overall Feasibility -->
      <div class="widget" id="widget-burnout">
        <div class="widget-title">‚ö†Ô∏è Overall Feasibility</div>
        <div class="widget-value" id="burnout-value">-</div>
        <div class="widget-subtitle">Lead surplus/deficit (4 kids per team)</div>

        <div class="progress-container" style="margin-top:12px">
          <div class="progress-bar" id="burnout-bar"
               style="background: linear-gradient(90deg, #dc2626 0%, #fca5a5 100%)"></div>
          <div class="progress-label" id="burnout-label">-</div>
        </div>

        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px">
          <span style="color:#16a34a">Capacity: <b id="burnout-capacity">-</b></span>
          <span style="color:#dc2626">Demand: <b id="burnout-demand">-</b></span>
        </div>
      </div>

      <!-- Widget 2: Hidden Generals -->
      <div class="widget" id="widget-generals">
        <div class="widget-title">üéñÔ∏è Hidden Generals</div>
        <div class="widget-value" id="generals-value">-</div>
        <div class="widget-subtitle">Tech-skilled volunteers available to recruit</div>
      </div>

      <!-- Widget 3: Twin Engines Balance -->
      <div class="widget" id="widget-balance">
        <div class="widget-title">‚öñÔ∏è Twin Engines Balance</div>
        <div class="widget-subtitle">Regional Lead Distribution</div>

        <div class="bar-chart" id="balance-chart">
          <div class="bar-item">
            <div class="bar-label">Troy Hub</div>
            <div class="bar-visual">
              <div class="bar-fill" id="balance-east-bar" style="background:#16a34a"></div>
            </div>
            <div class="bar-count" id="balance-east-count">-</div>
          </div>
          <div class="bar-item">
            <div class="bar-label">Southfield Hub</div>
            <div class="bar-visual">
              <div class="bar-fill" id="balance-west-bar" style="background:#ca8a04"></div>
            </div>
            <div class="bar-count" id="balance-west-count">-</div>
          </div>
          <div class="bar-item">
            <div class="bar-label">Canton Hub</div>
            <div class="bar-visual">
              <div class="bar-fill" id="balance-south-bar" style="background:#dc2626"></div>
            </div>
            <div class="bar-count" id="balance-south-count">-</div>
          </div>
        </div>
      </div>

      <!-- Widget 4: Orphan Count -->
      <div class="widget" id="widget-orphan">
        <div class="widget-title">üö¶ Program Feasibility</div>
        <div class="widget-subtitle">Students without adequate mentors</div>

        <div class="traffic-lights">
          <div class="traffic-item">
            <div class="traffic-light">üü¢</div>
            <div class="traffic-details">
              <div class="traffic-program">FLL Explore (6-8)</div>
              <div class="traffic-stats"><span id="orphan-explore-students">-</span> students</div>
            </div>
          </div>

          <div class="traffic-item">
            <div class="traffic-light" id="orphan-challenge-light">üü°</div>
            <div class="traffic-details">
              <div class="traffic-program">FLL Challenge (9-12)</div>
              <div class="traffic-stats">
                <span id="orphan-challenge-students">-</span> students,
                <span id="orphan-challenge-leads">-</span> leads
                (ratio: <span id="orphan-challenge-ratio">-</span>:1)
              </div>
            </div>
          </div>

          <div class="traffic-item">
            <div class="traffic-light" id="orphan-ftc-light">üî¥</div>
            <div class="traffic-details">
              <div class="traffic-program">FTC (13-18)</div>
              <div class="traffic-stats">
                <span id="orphan-ftc-students">-</span> students,
                <span id="orphan-ftc-leads">-</span> FTC-capable leads
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Widget 5: Timings Distribution -->
      <div class="widget" id="widget-weekend">
        <div class="widget-title">üåÖ Timings Distribution</div>
        <div class="widget-subtitle">Family availability for meetups</div>

        <div class="bar-chart" id="timings-chart">
          <div class="bar-item">
            <div class="bar-label">Weekday PM</div>
            <div class="bar-visual">
              <div class="bar-fill" id="timing-weekday-bar" style="background:#f59e0b"></div>
            </div>
            <div class="bar-count" id="timing-weekday-count">-</div>
          </div>
          <div class="bar-item">
            <div class="bar-label">Weekend AM</div>
            <div class="bar-visual">
              <div class="bar-fill" id="timing-weekend-am-bar" style="background:#3b82f6"></div>
            </div>
            <div class="bar-count" id="timing-weekend-am-count">-</div>
          </div>
          <div class="bar-item">
            <div class="bar-label">Weekend PM</div>
            <div class="bar-visual">
              <div class="bar-fill" id="timing-weekend-pm-bar" style="background:#8b5cf6"></div>
            </div>
            <div class="bar-count" id="timing-weekend-pm-count">-</div>
          </div>
          <div class="bar-item">
            <div class="bar-label">Other</div>
            <div class="bar-visual">
              <div class="bar-fill" id="timing-other-bar" style="background:#10b981"></div>
            </div>
            <div class="bar-count" id="timing-other-count">-</div>
          </div>
        </div>
      </div>
    </div>

    <div id="stats-box" style="display:none">
      <h3>üìä Statistics</h3>
      <div class="stat-row"><span class="stat-label">Zip Codes</span><span class="stat-value" id="stat-zips">-</span></div>
      <div class="stat-row"><span class="stat-label">Households</span><span class="stat-value" id="stat-households">-</span></div>
      <div class="stat-row"><span class="stat-label">Total Kids</span><span class="stat-value" id="stat-kids">-</span></div>
      <div class="stat-row"><span class="stat-label">Ages 6-8</span><span class="stat-value" id="stat-age-6-8">-</span></div>
      <div class="stat-row"><span class="stat-label">Ages 9-12</span><span class="stat-value" id="stat-age-9-12">-</span></div>
      <div class="stat-row"><span class="stat-label">Ages 13-17</span><span class="stat-value" id="stat-age-13-17">-</span></div>
      <div class="stat-row"><span class="stat-label">Leaders</span><span class="stat-value" id="stat-leads">-</span></div>
      <div class="stat-row"><span class="stat-label">General Support</span><span class="stat-value" id="stat-general">-</span></div>
      <div class="stat-row"><span class="stat-label">Drop-off Only</span><span class="stat-value" id="stat-dropoff">-</span></div>
      <h3 style="margin-top:10px">ü§ñ FLL Planning</h3>
      <div class="stat-row"><span class="stat-label">Avg Kids/Household</span><span class="stat-value" id="stat-avg-kids">-</span></div>
      <div class="stat-row"><span class="stat-label">Kids per Leader</span><span class="stat-value" id="stat-ratio">-</span></div>
      <div class="stat-row"><span class="stat-label">Potential Teams</span><span class="stat-value" id="stat-teams">-</span></div>
    </div>
  </div>

<script>
  // Token injected server-side
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibXR3ZWFrIiwiYSI6ImNtbDJpZmV1ajA5cW4zaG9lZDhxa2tzeWMifQ.2nr8p2KeRQPbweXY5AL8hA';

  // ---- Helpers ----
  function normalizeZip(z) {
    if (!z) return null;
    const s = String(z).trim();
    const m = s.match(/\b(\d{5})(?:-\d{4})?\b/);
    if (m) return { kind: "US", code: m[1] };
    const c = s.toUpperCase().replace(/\s+/g, "");
    if (/^[ABCEGHJ-NPRSTVXY]\d[ABCEGHJ-NPRSTV-Z]\d[ABCEGHJ-NPRSTV-Z]\d$/.test(c)) {
      return { kind: "CA", code: c };
    }
    return null;
  }

  function extractAges(text) {
    if (!text) return [];
    const t = String(text);
    const ages = [];

    // Find all numbers that could be ages
    const re = /\b(\d{1,2})(?:\.(\d))?\b/g;
    let m;
    const candidates = [];

    while ((m = re.exec(t)) !== null) {
      const whole = parseInt(m[1], 10);
      if (Number.isFinite(whole) && whole >= 1 && whole <= 17) {
        candidates.push({ value: whole, index: m.index });
      }
    }

    // Filter out numbers that are likely counts, not ages
    for (const candidate of candidates) {
      const beforeText = t.substring(Math.max(0, candidate.index - 20), candidate.index).toLowerCase();
      const afterText = t.substring(candidate.index, Math.min(t.length, candidate.index + 30)).toLowerCase();

      // Skip if number appears right before "kids", "children", "family", "household"
      if (afterText.match(/^\d+\s*(kids|children|child|family|families|household)/)) {
        continue;
      }

      // Skip if preceded by "have", "with", "of" (likely a count)
      if (beforeText.match(/(have|with|of)\s*$/)) {
        continue;
      }

      ages.push(candidate.value);
    }

    return ages;
  }

  function bucketCount(ages, lo, hi) {
    return ages.filter(a => a >= lo && a <= hi).length;
  }

  function pickWeightMode() {
    const r = document.querySelector('input[name="weightMode"]:checked');
    return r ? r.value : "kids";
  }

  function setStatus(msg, cls="") {
    const el = document.getElementById("status");
    el.className = "small " + cls;
    el.textContent = msg;
  }

  async function geocodePostcode(code, kind, token) {
    const encoded = encodeURIComponent(code);
    let url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encoded}.json?types=postcode&limit=1&access_token=${encodeURIComponent(token)}`;
    if (kind === "US") url += "&country=us";
    if (kind === "CA") url += "&country=ca";
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Geocode failed for ${code}: ${res.status}`);
    const data = await res.json();
    const feat = data.features && data.features[0];
    if (!feat || !feat.center) throw new Error(`No geocode result for ${code}`);
    const [lon, lat] = feat.center;
    return { lon, lat, place_name: feat.place_name };
  }

  // ---- Map globals ----
  let map = null;
  let geojson = null;
  let rawRows = null;        // Store all parsed CSV rows for widget calculations
  let columnMap = null;      // Store column name mappings for easy access

  function initMap(token) {
    mapboxgl.accessToken = token;
    map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/light-v11",
      center: [-83.2, 42.5],
      zoom: 8
    });
    map.addControl(new mapboxgl.NavigationControl(), "top-right");
  }

  function addOrUpdateLayers() {
    if (!map) return;

    if (map.getSource("zips")) {
      map.getSource("zips").setData(geojson);
      return;
    }

    map.addSource("zips", { type: "geojson", data: geojson });

    map.addLayer({
      id: "heat",
      type: "heatmap",
      source: "zips",
      maxzoom: 12,
      paint: {
        "heatmap-weight": ["interpolate", ["linear"], ["get", "weight"], 0, 0, 10, 1],
        "heatmap-intensity": ["interpolate", ["linear"], ["zoom"], 0, 0.8, 8, 1.2, 12, 2.0],
        "heatmap-radius": ["interpolate", ["linear"], ["zoom"], 0, 10, 8, 25, 12, 45],
        "heatmap-opacity": ["interpolate", ["linear"], ["zoom"], 10, 0.9, 12, 0.2]
      }
    });

    map.addLayer({
      id: "points",
      type: "circle",
      source: "zips",
      minzoom: 10,
      paint: {
        "circle-radius": ["interpolate", ["linear"], ["zoom"], 10, 3, 14, 8],
        "circle-opacity": 0.75,
        "circle-stroke-width": 1,
        "circle-stroke-opacity": 0.7
      }
    });

    // Invisible layer for hover detection at all zoom levels
    map.addLayer({
      id: "points-hover",
      type: "circle",
      source: "zips",
      paint: {
        "circle-radius": ["interpolate", ["linear"], ["zoom"], 0, 15, 8, 30, 12, 50],
        "circle-opacity": 0
      }
    });

    // Lead Volunteer badge background - subtle
    map.addLayer({
      id: "lead-volunteers-bg",
      type: "circle",
      source: "zips",
      filter: [">", ["get", "leadVolunteerCount"], 0],
      paint: {
        "circle-radius": ["interpolate", ["linear"], ["zoom"], 6, 6, 12, 9],
        "circle-color": "#fff",
        "circle-stroke-color": "#065f46",
        "circle-stroke-width": 0.5,
        "circle-opacity": 0.7
      }
    });

    // Lead Volunteer count number
    map.addLayer({
      id: "lead-volunteers-count",
      type: "symbol",
      source: "zips",
      filter: [">", ["get", "leadVolunteerCount"], 0],
      layout: {
        "text-field": ["to-string", ["get", "leadVolunteerCount"]],
        "text-size": ["interpolate", ["linear"], ["zoom"], 6, 9, 12, 12],
        "text-allow-overlap": true,
        "text-font": ["DIN Pro Bold", "Arial Unicode MS Bold"]
      },
      paint: {
        "text-color": "#065f46",
        "text-opacity": 0.8
      }
    });

    // Tooltip for hover
    const tooltip = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    map.on("mousemove", "points-hover", (e) => {
      const f = e.features && e.features[0];
      if (!f) return;
      map.getCanvas().style.cursor = "pointer";
      const props = f.properties || {};
      const leadCount = props.leadVolunteerCount || 0;
      const leadBadge = leadCount > 0
        ? `<div style="color:#065f46;font-weight:bold">üéñÔ∏è ${leadCount} Leader${leadCount > 1 ? 's' : ''}</div>`
        : '';

      // Build age distribution bar graph
      const ages = (props.ages_summary || "")
        .split(",").map(s => parseInt(s.trim(), 10)).filter(n => Number.isFinite(n));
      const age6_8 = ages.filter(a => a >= 6 && a <= 8).length;
      const age9_12 = ages.filter(a => a >= 9 && a <= 12).length;
      const age13_17 = ages.filter(a => a >= 13 && a <= 17).length;
      const maxCount = Math.max(age6_8, age9_12, age13_17, 1);

      const barGraph = `
        <div style="margin-top:4px">
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:40px;font-size:11px">6-8</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#f59e0b;height:100%;width:${(age6_8/maxCount)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${age6_8}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:40px;font-size:11px">9-12</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#3b82f6;height:100%;width:${(age9_12/maxCount)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${age9_12}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:40px;font-size:11px">13-17</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#8b5cf6;height:100%;width:${(age13_17/maxCount)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${age13_17}</span>
          </div>
        </div>`;

      // Build timing distribution bar graph
      const timings = JSON.parse(props.timings || '{"weekdayEvenings":0,"weekendMornings":0,"weekendEvenings":0,"other":0}');
      const maxTiming = Math.max(timings.weekdayEvenings, timings.weekendMornings, timings.weekendEvenings, timings.other, 1);

      const timingGraph = `
        <div style="margin-top:8px">
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Weekday PM</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#f59e0b;height:100%;width:${(timings.weekdayEvenings/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.weekdayEvenings}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Weekend AM</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#3b82f6;height:100%;width:${(timings.weekendMornings/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.weekendMornings}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Weekend PM</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#8b5cf6;height:100%;width:${(timings.weekendEvenings/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.weekendEvenings}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Other</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#10b981;height:100%;width:${(timings.other/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.other}</span>
          </div>
        </div>`;

      const html =
        `<div style="font-size:13px;min-width:180px">
          <div><b>${props.postcode}</b></div>
          <div>${props.place_name || ""}</div>
          ${leadBadge}
          <hr/>
          <div><b>Weight:</b> ${props.weight}</div>
          <div><b>Households:</b> ${props.households}</div>
          <div><b>Kids:</b> ${props.kids}</div>
          <div style="margin-top:4px"><b>Age Distribution:</b></div>
          ${barGraph}
          <div style="margin-top:8px"><b>Availability:</b></div>
          ${timingGraph}
        </div>`;
      tooltip.setLngLat(e.lngLat).setHTML(html).addTo(map);
    });

    map.on("mouseleave", "points-hover", () => {
      map.getCanvas().style.cursor = "";
      tooltip.remove();
    });
  }

  function fitToData() {
    if (!geojson || !geojson.features || geojson.features.length === 0) return;
    let minLon = 180, minLat = 90, maxLon = -180, maxLat = -90;
    for (const f of geojson.features) {
      const [lon, lat] = f.geometry.coordinates;
      minLon = Math.min(minLon, lon); minLat = Math.min(minLat, lat);
      maxLon = Math.max(maxLon, lon); maxLat = Math.max(maxLat, lat);
    }
    map.fitBounds([[minLon, minLat], [maxLon, maxLat]], { padding: 40, duration: 500 });
  }

  // ---- Main build ----
  async function buildMap() {
    if (!MAPBOX_TOKEN || MAPBOX_TOKEN.includes('MAPBOX_TOKEN')) {
      setStatus("Mapbox token not configured.", "err");
      return;
    }

    setStatus("Loading dashboard.csv‚Ä¶");

    let csvText;
    try {
      const response = await fetch('dashboard.csv');
      if (!response.ok) {
        setStatus(`Failed to load dashboard.csv: ${response.status}`, "err");
        return;
      }
      csvText = await response.text();
    } catch (err) {
      setStatus(`Error loading dashboard.csv: ${err.message}`, "err");
      return;
    }

    setStatus("Parsing CSV‚Ä¶");

    const parsed = await new Promise((resolve, reject) => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: (r) => resolve(r),
        error: (e) => reject(e)
      });
    });

    if (parsed.errors && parsed.errors.length) {
      console.warn(parsed.errors);
    }

    const rows = parsed.data || [];
    if (!rows.length) { setStatus("No rows found in CSV.", "err"); return; }

    const colZip = Object.keys(rows[0]).find(k => /zip\s*code/i.test(k));
    const colKids = Object.keys(rows[0]).find(k => /(ages|genders).*children/i.test(k) || /future engineers/i.test(k));
    const colVolunteer = Object.keys(rows[0]).find(k => /community cooperative/i.test(k));

    if (!colZip) { setStatus("Could not find ZIP column in CSV headers.", "err"); return; }
    if (!colKids) { setStatus("Could not find kids/ages column in CSV headers.", "err"); return; }

    // Store raw rows and column mappings for widget calculations
    rawRows = rows;
    columnMap = {
      zip: colZip,
      kids: colKids,
      volunteer: colVolunteer,
      mosque: Object.keys(rows[0]).find(k => /masjid does your family/i.test(k)),
      weekendMorning: Object.keys(rows[0]).find(k => /weekend mornings/i.test(k)),
      weekdayEvenings: Object.keys(rows[0]).find(k => /weekday evenings/i.test(k)),
      weekendEvenings: Object.keys(rows[0]).find(k => /weekend evenings/i.test(k)),
      other: Object.keys(rows[0]).find(k => /other/i.test(k) && /free for meetups/i.test(k))
    };

    const agg = new Map();
    let badZip = 0;

    for (const r of rows) {
      const nz = normalizeZip(r[colZip]);
      if (!nz) { badZip++; continue; }

      const ages = extractAges(r[colKids]);
      const kids = ages.length;

      const key = `${nz.kind}:${nz.code}`;
      if (!agg.has(key)) agg.set(key, {
        kind: nz.kind,
        code: nz.code,
        households: 0,
        kids: 0,
        ages: [],
        timings: { weekdayEvenings: 0, weekendMornings: 0, weekendEvenings: 0, other: 0 }
      });

      const a = agg.get(key);
      a.households += 1;
      a.kids += kids;
      a.ages.push(...ages);

      // Track timing availability
      if ((r[columnMap.weekdayEvenings] || "").toString().toLowerCase() === "true") {
        a.timings.weekdayEvenings++;
      }
      if ((r[columnMap.weekendMorning] || "").toString().toLowerCase() === "true") {
        a.timings.weekendMornings++;
      }
      if ((r[columnMap.weekendEvenings] || "").toString().toLowerCase() === "true") {
        a.timings.weekendEvenings++;
      }
      if ((r[columnMap.other] || "").toString().toLowerCase() === "true") {
        a.timings.other++;
      }

      // Count volunteer types
      if (colVolunteer) {
        const volVal = (r[colVolunteer] || "").toString().trim().toLowerCase();
        if (volVal.startsWith("lead volunteer") || volVal.startsWith("head coach")) {
          a.leadVolunteerCount = (a.leadVolunteerCount || 0) + 1;
        } else if (volVal.startsWith("general support")) {
          a.generalSupportCount = (a.generalSupportCount || 0) + 1;
        } else if (volVal.startsWith("drop-off") || volVal.startsWith("drop off")) {
          a.dropoffCount = (a.dropoffCount || 0) + 1;
        }
      }
    }

    if (agg.size === 0) {
      setStatus(`No usable ZIP/postal codes found. Bad/empty: ${badZip}`, "err");
      return;
    }

    setStatus(`Found ${agg.size} unique postcodes. Geocoding‚Ä¶`);

    if (!map) initMap(MAPBOX_TOKEN);

    const entries = Array.from(agg.entries()).map(([key, v]) => ({ key, ...v }));
    const results = [];
    const concurrency = 6;
    let idx = 0;
    let done = 0;
    const failures = [];

    async function worker() {
      while (idx < entries.length) {
        const i = idx++;
        const e = entries[i];
        try {
          const geo = await geocodePostcode(e.code, e.kind, MAPBOX_TOKEN);
          results.push({ ...e, ...geo });
        } catch (err) {
          failures.push({ e, err: String(err) });
        } finally {
          done++;
          if (done % 5 === 0 || done === entries.length) {
            setStatus(`Geocoding‚Ä¶ ${done}/${entries.length} done. Failures: ${failures.length}`);
          }
        }
      }
    }

    await Promise.all(Array.from({length: Math.min(concurrency, entries.length)}, worker));

    if (results.length === 0) {
      setStatus(`Geocoding failed for all postcodes. Check token + Mapbox access.`, "err");
      console.error(failures);
      return;
    }

    const weightMode = pickWeightMode();

    geojson = {
      type: "FeatureCollection",
      features: results.map(r => {
        const ages = r.ages || [];
        let weight = r.kids;

        if (weightMode === "households") weight = r.households;
        if (weightMode === "kids_6_8") weight = bucketCount(ages, 6, 8);
        if (weightMode === "kids_9_12") weight = bucketCount(ages, 9, 12);
        if (weightMode === "kids_13_17") weight = bucketCount(ages, 13, 17);

        const agesSummary = JSON.stringify({
          '6-8': bucketCount(ages, 6, 8),
          '9-12': bucketCount(ages, 9, 12),
          '13-17': bucketCount(ages, 13, 17)
        });
        return {
          type: "Feature",
          geometry: { type: "Point", coordinates: [r.lon, r.lat] },
          properties: {
            postcode: r.code,
            country: r.kind,
            place_name: r.place_name || "",
            households: r.households,
            kids: r.kids,
            weight: weight,
            ages_summary: agesSummary,
            leadVolunteerCount: r.leadVolunteerCount || 0,
            timings: JSON.stringify(r.timings || { weekdayEvenings: 0, weekendMornings: 0, weekendEvenings: 0, other: 0 })
          }
        };
      })
    };

    if (!map.isStyleLoaded()) {
      map.once("load", () => {
        addOrUpdateLayers();
        fitToData();
      });
    } else {
      addOrUpdateLayers();
      fitToData();
    }

    const modeLabel = {
      kids: "# kids",
      households: "households",
      kids_6_8: "kids 6‚Äì8",
      kids_9_12: "kids 9‚Äì12",
      kids_13_17: "kids 13‚Äì17"
    }[weightMode] || weightMode;

    setStatus(`Map built. Weighted by ${modeLabel}. Geocoded: ${results.length}/${entries.length}. Failures: ${failures.length}`);

    // Update statistics box
    let totalHouseholds = 0, totalKids = 0, totalLeads = 0;
    let totalGeneral = 0, totalDropoff = 0;
    let age6_8 = 0, age9_12 = 0, age13_17 = 0;
    for (const r of results) {
      totalHouseholds += r.households;
      totalKids += r.kids;
      totalLeads += r.leadVolunteerCount || 0;
      totalGeneral += r.generalSupportCount || 0;
      totalDropoff += r.dropoffCount || 0;
      for (const a of (r.ages || [])) {
        if (a >= 6 && a <= 8) age6_8++;
        else if (a >= 9 && a <= 12) age9_12++;
        else if (a >= 13 && a <= 17) age13_17++;
      }
    }

    // FLL teams typically 4-6 kids, need 2 coaches per team
    const avgKidsPerHousehold = totalHouseholds > 0 ? (totalKids / totalHouseholds).toFixed(1) : 0;
    const kidsPerLeader = totalLeads > 0 ? (totalKids / totalLeads).toFixed(1) : '‚àû';
    const fllTeamSize = 6;
    const potentialTeams = Math.floor(totalKids / fllTeamSize);

    document.getElementById('stat-zips').textContent = results.length;
    document.getElementById('stat-households').textContent = totalHouseholds;
    document.getElementById('stat-kids').textContent = totalKids;
    document.getElementById('stat-age-6-8').textContent = age6_8;
    document.getElementById('stat-age-9-12').textContent = age9_12;
    document.getElementById('stat-age-13-17').textContent = age13_17;
    document.getElementById('stat-leads').textContent = totalLeads;
    document.getElementById('stat-general').textContent = totalGeneral;
    document.getElementById('stat-dropoff').textContent = totalDropoff;
    document.getElementById('stat-avg-kids').textContent = avgKidsPerHousehold;
    document.getElementById('stat-ratio').textContent = kidsPerLeader;
    document.getElementById('stat-teams').textContent = potentialTeams;
    document.getElementById('stats-box').style.display = 'block';

    // Update widgets panel
    updateWidgets();

    if (failures.length) console.warn("Geocode failures:", failures);

    // Load and display masjids after main data is loaded
    loadMasjids();
  }

  // Load and display masjid locations
  async function loadMasjids() {
    if (!map) return;

    try {
      const res = await fetch('masjids.csv');
      if (!res.ok) {
        console.warn('Could not load masjids.csv');
        return;
      }

      const csvText = await res.text();
      const rows = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
      console.log(`Parsed ${rows.length} masjid rows from CSV`);

      // Geocode masjids and create GeoJSON
      const masjidFeatures = [];
      for (const row of rows) {
        const zipCode = row['Zip Code'];
        const name = row['Organization Name'];
        const abbr = row['Abbr.'] === '--' ? '' : row['Abbr.'];
        const hub = row['Hub Alignment'];

        if (!zipCode) continue;

        try {
          const geo = await geocodePostcode(zipCode, 'US', MAPBOX_TOKEN);
          masjidFeatures.push({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [geo.lon, geo.lat] },
            properties: {
              name: name,
              abbr: abbr,
              hub: hub,
              zipCode: zipCode
            }
          });
        } catch (e) {
          console.warn(`Failed to geocode masjid ${name}:`, e);
        }
      }

      if (masjidFeatures.length === 0) return;

      // Add masjid source and layers
      if (!map.getSource('masjids')) {
        map.addSource('masjids', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: masjidFeatures }
        });

        // Masjid markers (circle instead of emoji for reliability)
        map.addLayer({
          id: 'masjid-markers',
          type: 'circle',
          source: 'masjids',
          paint: {
            'circle-radius': 8,
            'circle-color': '#16a34a',
            'circle-stroke-color': '#ffffff',
            'circle-stroke-width': 2,
            'circle-opacity': 0.9
          }
        });

        // Masjid labels
        map.addLayer({
          id: 'masjid-labels',
          type: 'symbol',
          source: 'masjids',
          layout: {
            'text-field': ['get', 'abbr'],
            'text-size': 10,
            'text-anchor': 'top',
            'text-offset': [0, 1.2],
            'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold']
          },
          paint: {
            'text-color': '#065f46',
            'text-halo-color': '#fff',
            'text-halo-width': 1.5
          }
        });

        // Masjid tooltips
        const masjidTooltip = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

        map.on('mouseenter', 'masjid-markers', (e) => {
          map.getCanvas().style.cursor = 'pointer';
          const f = e.features[0];
          const props = f.properties;

          masjidTooltip.setLngLat(e.lngLat).setHTML(`
            <div style="font-size:13px">
              <div><b>üïå ${props.name}</b></div>
              ${props.abbr ? `<div style="color:#6b7280">${props.abbr}</div>` : ''}
              <hr style="margin:4px 0"/>
              <div><b>Hub:</b> ${props.hub}</div>
              <div><b>Zip:</b> ${props.zipCode}</div>
            </div>
          `).addTo(map);
        });

        map.on('mouseleave', 'masjid-markers', () => {
          map.getCanvas().style.cursor = '';
          masjidTooltip.remove();
        });
      }

      console.log(`Loaded ${masjidFeatures.length} masjid locations`);
    } catch (e) {
      console.error('Error loading masjids:', e);
    }
  }

  // Rebuild weights instantly when toggling modes (no re-geocode)
  document.querySelectorAll('input[name="weightMode"]').forEach(el => {
    el.addEventListener("change", () => {
      if (!geojson) return;
      const mode = pickWeightMode();
      for (const f of geojson.features) {
        const ages = (f.properties.ages_summary || "")
          .split(",").map(s => parseInt(s.trim(), 10)).filter(n => Number.isFinite(n));
        const kids = f.properties.kids;
        const households = f.properties.households;
        let weight = kids;
        if (mode === "households") weight = households;
        if (mode === "kids_6_8") weight = bucketCount(ages, 6, 8);
        if (mode === "kids_9_12") weight = bucketCount(ages, 9, 12);
        if (mode === "kids_13_17") weight = bucketCount(ages, 13, 17);
        f.properties.weight = weight;
      }
      addOrUpdateLayers();
      updateWidgets();
      setStatus(`Updated weighting: ${mode}`);
    });
  });

  // K-means clustering
  function kmeans(points, k, maxIterations = 50) {
    if (points.length === 0 || k <= 0) return { clusters: [], assignments: [] };

    // Initialize centroids randomly from points
    const centroids = [];
    const used = new Set();
    while (centroids.length < Math.min(k, points.length)) {
      const idx = Math.floor(Math.random() * points.length);
      if (!used.has(idx)) {
        used.add(idx);
        centroids.push({ lon: points[idx].lon, lat: points[idx].lat });
      }
    }

    let assignments = [];
    for (let iter = 0; iter < maxIterations; iter++) {
      // Assign points to nearest centroid
      assignments = points.map(p => {
        let minDist = Infinity, closest = 0;
        centroids.forEach((c, i) => {
          const d = Math.pow(p.lon - c.lon, 2) + Math.pow(p.lat - c.lat, 2);
          if (d < minDist) { minDist = d; closest = i; }
        });
        return closest;
      });

      // Update centroids
      const newCentroids = centroids.map(() => ({ sumLon: 0, sumLat: 0, count: 0 }));
      points.forEach((p, i) => {
        const c = assignments[i];
        newCentroids[c].sumLon += p.lon;
        newCentroids[c].sumLat += p.lat;
        newCentroids[c].count++;
      });

      let converged = true;
      newCentroids.forEach((nc, i) => {
        if (nc.count > 0) {
          const newLon = nc.sumLon / nc.count;
          const newLat = nc.sumLat / nc.count;
          if (Math.abs(centroids[i].lon - newLon) > 0.0001 || Math.abs(centroids[i].lat - newLat) > 0.0001) {
            converged = false;
          }
          centroids[i].lon = newLon;
          centroids[i].lat = newLat;
        }
      });

      if (converged) break;
    }

    // Build cluster data with convex hulls
    const clusters = centroids.map((c, i) => {
      const clusterPoints = points.filter((_, pi) => assignments[pi] === i);

      // Aggregate age distribution
      const agesSummary = { '6-8': 0, '9-12': 0, '13-17': 0 };
      clusterPoints.forEach((p, idx) => {
        if (p.ages_summary) {
          try {
            // Handle both object and string formats
            const ages = typeof p.ages_summary === 'string'
              ? JSON.parse(p.ages_summary)
              : p.ages_summary;

            if (idx === 0) {
              console.log('First point ages_summary:', p.ages_summary);
              console.log('Parsed ages:', ages);
            }

            agesSummary['6-8'] += ages['6-8'] || 0;
            agesSummary['9-12'] += ages['9-12'] || 0;
            agesSummary['13-17'] += ages['13-17'] || 0;
          } catch (e) {
            console.error('Error parsing ages_summary:', e, p.ages_summary);
          }
        }
      });

      console.log('Cluster', i, 'final agesSummary:', agesSummary);

      // Aggregate timing distribution
      const timings = { weekdayEvenings: 0, weekendMornings: 0, weekendEvenings: 0, other: 0 };
      clusterPoints.forEach(p => {
        if (p.timings) {
          try {
            // Handle both object and string formats
            const t = typeof p.timings === 'string'
              ? JSON.parse(p.timings)
              : p.timings;
            timings.weekdayEvenings += t.weekdayEvenings || 0;
            timings.weekendMornings += t.weekendMornings || 0;
            timings.weekendEvenings += t.weekendEvenings || 0;
            timings.other += t.other || 0;
          } catch (e) {
            console.error('Error parsing timings:', e, p.timings);
          }
        }
      });

      return {
        center: [c.lon, c.lat],
        points: clusterPoints,
        pointCount: clusterPoints.length,
        totalKids: clusterPoints.reduce((sum, p) => sum + (p.kids || 0), 0),
        leaders: clusterPoints.reduce((sum, p) => sum + (p.leadVolunteerCount || 0), 0),
        agesSummary: JSON.stringify(agesSummary),
        timings: JSON.stringify(timings)
      };
    });

    return { clusters: clusters.filter(c => c.pointCount > 0), assignments };
  }

  // Convex hull using Graham scan
  function convexHull(points) {
    if (points.length < 3) return points.map(p => [p.lon, p.lat]);

    const pts = points.map(p => ({ x: p.lon, y: p.lat }));

    // Find lowest point (bottom-most, then left-most)
    let lowest = 0;
    for (let i = 1; i < pts.length; i++) {
      if (pts[i].y < pts[lowest].y || (pts[i].y === pts[lowest].y && pts[i].x < pts[lowest].x)) {
        lowest = i;
      }
    }
    [pts[0], pts[lowest]] = [pts[lowest], pts[0]];

    const pivot = pts[0];

    // Cross product for turning direction
    function cross(o, a, b) {
      return (a.x - o.x) * (b.y - o.y) - (a.y - o.y) * (b.x - o.x);
    }

    // Sort remaining points by polar angle with respect to pivot
    const sorted = [pivot].concat(
      pts.slice(1).sort((a, b) => {
        const angleA = Math.atan2(a.y - pivot.y, a.x - pivot.x);
        const angleB = Math.atan2(b.y - pivot.y, b.x - pivot.x);
        if (Math.abs(angleA - angleB) > 0.000001) return angleA - angleB;
        // If same angle, closer point first
        const distA = Math.pow(a.x - pivot.x, 2) + Math.pow(a.y - pivot.y, 2);
        const distB = Math.pow(b.x - pivot.x, 2) + Math.pow(b.y - pivot.y, 2);
        return distA - distB;
      })
    );

    // Graham scan
    const hull = [sorted[0]];
    for (let i = 1; i < sorted.length; i++) {
      while (hull.length > 1 && cross(hull[hull.length - 2], hull[hull.length - 1], sorted[i]) <= 0) {
        hull.pop();
      }
      hull.push(sorted[i]);
    }

    return hull.map(p => [p.x, p.y]);
  }

  const clusterColors = ['#e63946','#2a9d8f','#e9c46a','#264653','#f4a261','#8338ec','#06d6a0','#118ab2','#ef476f','#ffd166'];

  // ---- Widget Calculation Functions ----

  function calculateBurnout() {
    if (!rawRows) return { deficit: 0, capacity: 0, demand: 0, leadCount: 0 };

    let leadCount = 0;
    let totalStudents = 0;

    // Debug logging
    console.log('=== Debugging kid count ===');
    let debugCount = 0;

    for (const row of rawRows) {
      const volunteer = (row[columnMap.volunteer] || "").toString().trim().toLowerCase();
      // Use startsWith for more accurate matching
      if (volunteer.startsWith("lead volunteer") || volunteer.startsWith("head coach")) {
        leadCount++;
      }

      const kidsText = row[columnMap.kids];
      const ages = extractAges(kidsText);
      if (ages.length > 0) {
        debugCount++;
        if (debugCount <= 10) {
          console.log(`Row ${debugCount}: "${kidsText}" -> ages:`, ages, `(${ages.length} kids)`);
        }
      }
      totalStudents += ages.length;
    }

    console.log(`Total rows with kids: ${debugCount}, Total kids counted: ${totalStudents}`);
    console.log('=========================');

    // FLL team structure: ~4 kids per lead
    const capacity = leadCount * 4; // Total kids that can be served
    const deficit = capacity - totalStudents; // Surplus or deficit in kids

    return { deficit, capacity, demand: totalStudents, leadCount };
  }

  function calculateHiddenGenerals() {
    if (!rawRows) return 0;

    let count = 0;

    for (const row of rawRows) {
      const volunteer = (row[columnMap.volunteer] || "").toString().trim().toLowerCase();
      if (!volunteer.startsWith("general support")) continue;

      // Check interest columns for Technical Mentor or CAD & Design
      const interestCols = Object.keys(row).filter(k =>
        /which areas.*interested/i.test(k) &&
        /(technical mentor|cad.*design)/i.test(k)
      );

      const hasTechSkill = interestCols.some(col =>
        (row[col] || "").toLowerCase() === "true"
      );

      if (hasTechSkill) count++;
    }

    return count;
  }

  // Mosque to region mapping
  const mosqueToRegion = {
    'iagd': 'East', 'iona': 'East', 'troy': 'East', 'rochester': 'East',
    'tawheed': 'West', 'mcm': 'West', 'southfield': 'West',
    'amda': 'South', 'miftaah': 'South', 'canton': 'South',
    'ann arbor': 'South', 'farmington': 'South'
  };

  function calculateRegionalBalance() {
    if (!rawRows) return { East: 0, West: 0, South: 0 };

    const regions = { East: 0, West: 0, South: 0 };

    for (const row of rawRows) {
      const volunteer = (row[columnMap.volunteer] || "").toString().trim().toLowerCase();
      if (!volunteer.startsWith("lead volunteer") && !volunteer.startsWith("head coach")) continue;

      const mosque = (row[columnMap.mosque] || "").toLowerCase();

      // Find matching region
      for (const [key, region] of Object.entries(mosqueToRegion)) {
        if (mosque.includes(key)) {
          regions[region]++;
          break;
        }
      }
    }

    return regions;
  }

  function getRegionColor(count) {
    if (count >= 8) return '#16a34a'; // Green
    if (count >= 4) return '#ca8a04'; // Yellow
    return '#dc2626'; // Red
  }

  function calculateOrphanCount() {
    if (!rawRows) return { explore: {}, challenge: {}, ftc: {} };

    let explore = { students: 0 };
    let challenge = { students: 0, leads: 0 };
    let ftc = { students: 0, leads: 0 };

    for (const row of rawRows) {
      const ages = extractAges(row[columnMap.kids]);

      // Count students by age range
      explore.students += ages.filter(a => a >= 6 && a <= 8).length;
      challenge.students += ages.filter(a => a >= 9 && a <= 12).length;
      ftc.students += ages.filter(a => a >= 13 && a <= 18).length;

      // Count leads
      const volunteer = (row[columnMap.volunteer] || "").toString().trim().toLowerCase();
      if (volunteer.startsWith("lead volunteer") || volunteer.startsWith("head coach")) {
        challenge.leads++;

        // Check for Technical Mentor or CAD & Design interests (FTC-capable)
        const interestCols = Object.keys(row).filter(k =>
          /which areas.*interested/i.test(k) &&
          /(technical mentor|cad.*design)/i.test(k)
        );

        const isFTCCapable = interestCols.some(col =>
          (row[col] || "").toLowerCase() === "true"
        );

        if (isFTCCapable) {
          ftc.leads++;
        }
      }
    }

    // Calculate ratios and traffic lights
    challenge.ratio = challenge.leads > 0 ? (challenge.students / challenge.leads).toFixed(1) : '‚àû';
    challenge.status = challenge.ratio > 6 ? 'yellow' : 'green';

    explore.status = explore.students >= 20 ? 'green' : 'yellow';
    ftc.status = ftc.leads >= 3 ? 'green' : 'red';

    return { explore, challenge, ftc };
  }

  function calculateTimingsDistribution() {
    if (!rawRows) return { weekdayEvenings: 0, weekendMornings: 0, weekendEvenings: 0, other: 0 };

    let weekdayEvenings = 0;
    let weekendMornings = 0;
    let weekendEvenings = 0;
    let other = 0;

    for (const row of rawRows) {
      if ((row[columnMap.weekdayEvenings] || "").toLowerCase() === "true") {
        weekdayEvenings++;
      }
      if ((row[columnMap.weekendMorning] || "").toLowerCase() === "true") {
        weekendMornings++;
      }
      if ((row[columnMap.weekendEvenings] || "").toLowerCase() === "true") {
        weekendEvenings++;
      }
      if ((row[columnMap.other] || "").toLowerCase() === "true") {
        other++;
      }
    }

    return { weekdayEvenings, weekendMornings, weekendEvenings, other };
  }

  function generateDonutSVG(percentage) {
    const radius = 15.91549430918954; // circumference = 100
    const filledCircumference = percentage;
    const emptyCircumference = 100 - percentage;

    return `
      <circle cx="21" cy="21" r="${radius}" fill="transparent"
              stroke="#e5e7eb" stroke-width="6"></circle>
      <circle cx="21" cy="21" r="${radius}" fill="transparent"
              stroke="#3b82f6" stroke-width="6"
              stroke-dasharray="${filledCircumference} ${emptyCircumference}"
              stroke-dashoffset="25"
              transform="rotate(-90 21 21)"></circle>
    `;
  }

  function updateWidgets() {
    if (!rawRows || !geojson) return;

    // Widget 1: Overall Feasibility
    const burnout = calculateBurnout();

    // Create explanation text (all in kids)
    let explanationText = '';
    if (burnout.deficit < 0) {
      explanationText = `${Math.abs(burnout.deficit)} kids unserved`;
    } else {
      explanationText = `Can serve ${burnout.deficit} more kids`;
    }

    document.getElementById('burnout-value').textContent = burnout.deficit;
    document.getElementById('burnout-value').className =
      'widget-value ' + (burnout.deficit < 0 ? 'value-red' : 'value-green');
    document.getElementById('burnout-capacity').textContent = `${burnout.capacity} kids (${burnout.leadCount} leads)`;
    document.getElementById('burnout-demand').textContent = `${burnout.demand} kids`;
    document.getElementById('burnout-label').textContent = explanationText;

    // Progress bar visualization
    const barWidth = burnout.demand > 0
      ? Math.min((burnout.capacity / burnout.demand) * 100, 100)
      : 0;
    document.getElementById('burnout-bar').style.width = barWidth + '%';

    // Change bar color based on surplus/deficit
    const barColor = burnout.deficit >= 0
      ? 'linear-gradient(90deg, #16a34a 0%, #86efac 100%)' // Green for surplus
      : 'linear-gradient(90deg, #dc2626 0%, #fca5a5 100%)'; // Red for deficit
    document.getElementById('burnout-bar').style.background = barColor;

    // Widget 2: Hidden Generals
    const generals = calculateHiddenGenerals();
    document.getElementById('generals-value').textContent = generals;

    // Widget 3: Regional Balance
    const balance = calculateRegionalBalance();
    const maxLeads = Math.max(balance.East, balance.West, balance.South, 1);

    ['East', 'West', 'South'].forEach(region => {
      const count = balance[region];
      const barId = `balance-${region.toLowerCase()}-bar`;
      const countId = `balance-${region.toLowerCase()}-count`;

      document.getElementById(countId).textContent = count;
      document.getElementById(barId).style.width = (count / maxLeads * 100) + '%';
      document.getElementById(barId).style.background = getRegionColor(count);
    });

    // Widget 4: Orphan Count
    const orphan = calculateOrphanCount();

    document.getElementById('orphan-explore-students').textContent = orphan.explore.students;

    document.getElementById('orphan-challenge-students').textContent = orphan.challenge.students;
    document.getElementById('orphan-challenge-leads').textContent = orphan.challenge.leads;
    document.getElementById('orphan-challenge-ratio').textContent = orphan.challenge.ratio;
    document.getElementById('orphan-challenge-light').textContent =
      orphan.challenge.status === 'green' ? 'üü¢' : 'üü°';

    document.getElementById('orphan-ftc-students').textContent = orphan.ftc.students;
    document.getElementById('orphan-ftc-leads').textContent = orphan.ftc.leads;
    document.getElementById('orphan-ftc-light').textContent =
      orphan.ftc.status === 'green' ? 'üü¢' : 'üî¥';

    // Widget 5: Timings Distribution
    const timings = calculateTimingsDistribution();
    const maxTiming = Math.max(timings.weekdayEvenings, timings.weekendMornings, timings.weekendEvenings, timings.other, 1);

    document.getElementById('timing-weekday-count').textContent = timings.weekdayEvenings;
    document.getElementById('timing-weekday-bar').style.width = (timings.weekdayEvenings / maxTiming * 100) + '%';

    document.getElementById('timing-weekend-am-count').textContent = timings.weekendMornings;
    document.getElementById('timing-weekend-am-bar').style.width = (timings.weekendMornings / maxTiming * 100) + '%';

    document.getElementById('timing-weekend-pm-count').textContent = timings.weekendEvenings;
    document.getElementById('timing-weekend-pm-bar').style.width = (timings.weekendEvenings / maxTiming * 100) + '%';

    document.getElementById('timing-other-count').textContent = timings.other;
    document.getElementById('timing-other-bar').style.width = (timings.other / maxTiming * 100) + '%';

    // Show panel
    document.getElementById('widgets-panel').style.display = 'block';
  }

  function showClusters() {
    if (!geojson || !map) return;

    clearClusters();

    const k = parseInt(document.getElementById('cluster-count').value) || 2;
    const points = geojson.features.map(f => ({
      lon: f.geometry.coordinates[0],
      lat: f.geometry.coordinates[1],
      kids: f.properties.kids,
      leadVolunteerCount: f.properties.leadVolunteerCount,
      ages_summary: f.properties.ages_summary,
      timings: f.properties.timings
    }));

    const { clusters } = kmeans(points, k);

    // Create GeoJSON for cluster convex hull polygons
    const hullFeatures = clusters.map((c, i) => {
      const hull = convexHull(c.points);
      if (hull.length > 0) hull.push(hull[0]); // close polygon

      return {
        type: 'Feature',
        geometry: {
          type: hull.length >= 4 ? 'Polygon' : 'Point',
          coordinates: hull.length >= 4 ? [hull] : c.center
        },
        properties: {
          color: clusterColors[i % clusterColors.length],
          pointCount: c.pointCount,
          totalKids: c.totalKids,
          leaders: c.leaders,
          index: i + 1,
          agesSummary: c.agesSummary,
          timings: c.timings
        }
      };
    });

    // Cluster centers for labels
    const centerFeatures = clusters.map((c, i) => ({
      type: 'Feature',
      geometry: { type: 'Point', coordinates: c.center },
      properties: {
        color: clusterColors[i % clusterColors.length],
        pointCount: c.pointCount,
        totalKids: c.totalKids,
        leaders: c.leaders,
        index: i + 1,
        agesSummary: c.agesSummary,
        timings: c.timings
      }
    }));

    map.addSource('clusters', { type: 'geojson', data: { type: 'FeatureCollection', features: hullFeatures } });
    map.addSource('cluster-centers', { type: 'geojson', data: { type: 'FeatureCollection', features: centerFeatures } });

    // Cluster polygon fills
    map.addLayer({
      id: 'cluster-fills',
      type: 'fill',
      source: 'clusters',
      paint: {
        'fill-color': ['get', 'color'],
        'fill-opacity': 0.2
      }
    }, 'heat');

    // Cluster polygon outlines
    map.addLayer({
      id: 'cluster-outlines',
      type: 'line',
      source: 'clusters',
      paint: {
        'line-color': ['get', 'color'],
        'line-width': 2,
        'line-opacity': 0.9
      }
    });

    // Cluster centroid markers
    map.addLayer({
      id: 'cluster-centroids',
      type: 'circle',
      source: 'cluster-centers',
      paint: {
        'circle-radius': 8,
        'circle-color': ['get', 'color'],
        'circle-stroke-color': '#fff',
        'circle-stroke-width': 2,
        'circle-opacity': 0.9
      }
    });

    // Cluster labels at center
    map.addLayer({
      id: 'cluster-labels',
      type: 'symbol',
      source: 'cluster-centers',
      layout: {
        'text-field': ['concat', 'C', ['to-string', ['get', 'index']]],
        'text-size': 16,
        'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold'],
        'text-allow-overlap': true
      },
      paint: {
        'text-color': ['get', 'color'],
        'text-halo-color': '#fff',
        'text-halo-width': 2
      }
    });

    // Cluster tooltips
    const clusterTooltip = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

    map.on('mouseenter', 'cluster-fills', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      const f = e.features[0];
      const props = f.properties;
      const capacity = props.leaders * 4; // Total kids that can be served
      const feasibility = capacity - props.totalKids; // Surplus or deficit in kids
      const feasibilityColor = feasibility >= 0 ? '#16a34a' : '#dc2626';

      // Create explanation text (all in kids)
      let feasibilityText = '';
      if (feasibility < 0) {
        feasibilityText = `${Math.abs(feasibility)} kids unserved`;
      } else {
        feasibilityText = `Can serve ${feasibility} more kids`;
      }

      // Build age distribution bar graph
      const ages = JSON.parse(props.agesSummary || '{"6-8":0,"9-12":0,"13-17":0}');
      const age6_8 = ages['6-8'] || 0;
      const age9_12 = ages['9-12'] || 0;
      const age13_17 = ages['13-17'] || 0;
      const maxCount = Math.max(age6_8, age9_12, age13_17, 1);

      const ageGraph = `
        <div style="margin-top:8px">
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:40px;font-size:11px">6-8</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#f59e0b;height:100%;width:${(age6_8/maxCount)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${age6_8}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:40px;font-size:11px">9-12</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#3b82f6;height:100%;width:${(age9_12/maxCount)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${age9_12}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:40px;font-size:11px">13-17</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#8b5cf6;height:100%;width:${(age13_17/maxCount)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${age13_17}</span>
          </div>
        </div>`;

      // Build timing distribution bar graph
      const timings = JSON.parse(props.timings || '{"weekdayEvenings":0,"weekendMornings":0,"weekendEvenings":0,"other":0}');
      const maxTiming = Math.max(timings.weekdayEvenings, timings.weekendMornings, timings.weekendEvenings, timings.other, 1);

      const timingGraph = `
        <div style="margin-top:8px">
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Weekday PM</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#f59e0b;height:100%;width:${(timings.weekdayEvenings/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.weekdayEvenings}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Weekend AM</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#3b82f6;height:100%;width:${(timings.weekendMornings/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.weekendMornings}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Weekend PM</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#8b5cf6;height:100%;width:${(timings.weekendEvenings/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.weekendEvenings}</span>
          </div>
          <div style="display:flex;align-items:center;gap:4px;margin:2px 0">
            <span style="width:70px;font-size:11px">Other</span>
            <div style="background:#e5e7eb;height:12px;flex:1;border-radius:2px">
              <div style="background:#10b981;height:100%;width:${(timings.other/maxTiming)*100}%;border-radius:2px"></div>
            </div>
            <span style="width:16px;font-size:11px;text-align:right">${timings.other}</span>
          </div>
        </div>`;

      clusterTooltip.setLngLat(e.lngLat).setHTML(`
        <div style="font-size:13px">
          <div><b>Cluster ${props.index}</b></div>
          <hr/>
          <div><b>Locations:</b> ${props.pointCount}</div>
          <div><b>Kids:</b> ${props.totalKids}</div>
          <div><b>Capacity:</b> ${capacity} kids (${props.leaders} leads)</div>
          <div><b>Feasibility:</b> <span style="color:${feasibilityColor};font-weight:700">${feasibilityText}</span></div>
          <div style="margin-top:4px"><b>Age Distribution:</b></div>
          ${ageGraph}
          <div style="margin-top:8px"><b>Availability:</b></div>
          ${timingGraph}
        </div>
      `).addTo(map);
    });

    map.on('mouseleave', 'cluster-fills', () => {
      map.getCanvas().style.cursor = '';
      clusterTooltip.remove();
    });
  }

  function clearClusters() {
    if (!map) return;
    if (map.getLayer('cluster-labels')) map.removeLayer('cluster-labels');
    if (map.getLayer('cluster-centroids')) map.removeLayer('cluster-centroids');
    if (map.getLayer('cluster-points')) map.removeLayer('cluster-points');
    if (map.getLayer('cluster-outlines')) map.removeLayer('cluster-outlines');
    if (map.getLayer('cluster-fills')) map.removeLayer('cluster-fills');
    if (map.getSource('cluster-centers')) map.removeSource('cluster-centers');
    if (map.getSource('cluster-points')) map.removeSource('cluster-points');
    if (map.getSource('clusters')) map.removeSource('clusters');
  }

  document.getElementById('run-clusters').addEventListener('click', showClusters);
  document.getElementById('clear-clusters').addEventListener('click', clearClusters);

  // Auto-build on page load
  buildMap();
</script>
</body>
</html>
